<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Web NFC</title>
    <script>
        window.addEventListener('error', function (error) {
            if (ChromeSamples && ChromeSamples.setStatus) {
                console.error(error);
                ChromeSamples.setStatus(error.message + ' Tu navegador no soporta esta característica. Utiliza Chrome Android');
                error.preventDefault();
            }
        });
    </script>
</head>

<body>
    <h1>Web NFC</h1>
    <button id="scanButton">Escanear</button>
    <button id="writeButton">Escribir</button>
    <button id="makeReadOnlyButton">Modo lectura</button>
    <script>
        var ChromeSamples = {
            log: function () {
                var line = Array.prototype.slice.call(arguments).map(function (argument) {
                    return typeof argument === 'string' ? argument : JSON.stringify(argument);
                }).join(' ');

                document.querySelector('#log').textContent += line + '\n';
            },

            clearLog: function () {
                document.querySelector('#log').textContent = '';
            },

            setStatus: function (status) {
                document.querySelector('#status').textContent = status;
            },

            setContent: function (newContent) {
                var content = document.querySelector('#content');
                while (content.hasChildNodes()) {
                    content.removeChild(content.lastChild);
                }
                content.appendChild(newContent);
            }
        };
    </script>

    <h3>Salida</h3>
    <div id="output" class="output">
        <div id="content"></div>
        <div id="status"></div>
        <pre id="log"></pre>
    </div>

    <script>
        log = ChromeSamples.log;
        if (!("NDEFReader" in window))
            ChromeSamples.setStatus("Web NFC no funciona en este dispositivo. Utiliza Chrome Android");
    </script>
    <script>
        scanButton.addEventListener("click", async () => {

            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                log("> Esperando a escanear...");

                ndef.addEventListener("readingerror", () => {
                    log("Error en la lectura del NFC");
                });

                ndef.addEventListener("reading", ({ message, serialNumber }) => {
                    // Si el registro es de tipo "url"
                    if (message.records[0].recordType == "url") {
                        if ('toURL' in message.records[0]) {
                            window.location.href = message.records[0].toURL();
                        } else {
                            const dataView = new DataView(message.records[0].data.buffer);
                            const decoder = new TextDecoder('utf-8');
                            const urlBytes = decoder.decode(dataView);
                            window.location.href = urlBytes;
                        }
                    }
                    // Si el registro es de tipo "text"
                    else if (message.records[0].recordType == "text") {
                        if ('toText' in message.records[0]) {
                        } else {
                            const dataView = new DataView(message.records[0].data.buffer);
                            const decoder = new TextDecoder('utf-8');
                            const textBytes = decoder.decode(dataView);
                            alert(textBytes);
                        }
                    }
                });
            } catch (error) {
                log(error);
            }
        });


        writeButton.addEventListener("click", async () => {
            try {
            const textRecord = new NDEFRecord('text', '¡Hola, mundo!');
            const ndef = new NDEFWriter();
            
                await ndef.write(new NDEFMessage([textRecord]));
                log('Datos escritos correctamente.');
            } catch (error) {
                log(error);
            }
        });


        makeReadOnlyButton.addEventListener("click", async () => {
            log("User clicked make read-only button");

            try {
                const ndef = new NDEFReader();
                await ndef.makeReadOnly();
                log("> Modo sólo lectura");
            } catch (error) {
                log(error);
            }
        });
    </script>